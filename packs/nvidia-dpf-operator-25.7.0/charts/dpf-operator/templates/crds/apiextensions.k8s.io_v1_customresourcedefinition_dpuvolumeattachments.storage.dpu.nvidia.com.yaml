apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.5
    helm.sh/resource-policy: keep
  labels:
    app.kubernetes.io/part-of: dpf-operator-controller-manager
    dpu.nvidia.com/component: dpf-operator-controller-manager
  name: dpuvolumeattachments.storage.dpu.nvidia.com
spec:
  group: storage.dpu.nvidia.com
  names:
    kind: DPUVolumeAttachment
    listKind: DPUVolumeAttachmentList
    plural: dpuvolumeattachments
    singular: dpuvolumeattachment
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.dpuVolumeName
      name: DPUVolumeName
      type: string
    - jsonPath: .spec.dpuNodeName
      name: DPUNodeName
      type: string
    - jsonPath: .spec.functionType
      name: FunctionType
      type: string
    - jsonPath: .spec.hotplugFunction
      name: HotplugFunction
      type: boolean
    - jsonPath: .status.conditions[?(@.type=='Ready')].status
      name: Ready
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: DPUVolumeAttachment represents a Volume CR on the DPU cluster.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: DPUVolumeAttachmentSpec defines the desired state of DPUVolumeAttachment
            properties:
              dpuNodeName:
                description: |-
                  DPUNodeName is the name of DPUNode object that represents the node to which the volume should
                  be attached
                minLength: 1
                type: string
              dpuVolumeName:
                description: DPUVolumeName is the name of DPUVolume object that represents
                  the volume to be attached
                minLength: 1
                type: string
              functionType:
                description: FunctionType is the type of the emulated function that
                  should be used to attach the volume
                enum:
                - pf
                - vf
                type: string
              hotplugFunction:
                description: HotplugFunction is a boolean flag that indicates if the
                  emulated function should be hotplugged
                type: boolean
            required:
            - dpuNodeName
            - dpuVolumeName
            - functionType
            - hotplugFunction
            type: object
            x-kubernetes-validations:
            - message: hotplugFunction can only be true when functionType is 'pf'
              rule: '!(self.hotplugFunction == true && self.functionType != ''pf'')'
            - message: dpuNode field is immutable
              rule: self.dpuNodeName == oldSelf.dpuNodeName
            - message: dpuVolume field is immutable
              rule: self.dpuVolumeName == oldSelf.dpuVolumeName
            - message: functionType field is immutable
              rule: self.functionType == oldSelf.functionType
            - message: hotplugFunction field is immutable
              rule: self.hotplugFunction == oldSelf.hotplugFunction
          status:
            description: DPUVolumeAttachmentStatus defines the observed state of DPUVolumeAttachment
            properties:
              attachmentMetadata:
                additionalProperties:
                  type: string
                description: AttachmentMetadata contains the metadata of the volume
                  attachment returned by the Vendor CSI driver
                type: object
              conditions:
                description: Conditions defines current service state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              controllerAttached:
                description: Indicates the volume is successfully attached to by the
                  Vendor CSI driver
                type: boolean
              dpu:
                description: Details about the DPU attachment
                properties:
                  deviceName:
                    description: The name of the device that was created by the storage
                      vendor plugin
                    type: string
                  nvmeAttrs:
                    description: The attributes of the emulated NVME function
                    properties:
                      namespaceID:
                        description: The namespace ID within the NVME controller
                        format: int64
                        type: integer
                      namespaceUUID:
                        description: The NVMe namespace UUID
                        type: string
                    type: object
                  pciAddress:
                    description: 'PCI device address in the following format: (bus:device.function)'
                    type: string
                  virtioFSAttrs:
                    description: The attributes of the emulated VirtioFS function
                    properties:
                      filesystemTag:
                        description: Filesystem tag identified by SNAP on the host
                          (used for the mount). Relevant for volume of type filesystem
                        type: string
                    type: object
                type: object
              dpuAttached:
                description: Indicates the volume is successfully attached to the
                  node by DPU
                type: boolean
              message:
                description: The last error encountered during the attach operation,
                  if any
                type: string
              observedGeneration:
                description: ObservedGeneration records the Generation observed on
                  the object the last time it was patched.
                format: int64
                type: integer
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
